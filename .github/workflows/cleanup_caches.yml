name: Cleanup caches
on:
  workflow_dispatch:
  schedule:
    # at 00:00 on workdays
    - cron: '0 0 * * 1,2,3,4,5'

permissions: read-all

jobs:
  Cleanup_Pytest_Cache:
    name: Cleanup Pytest Cache
    runs-on: aks-linux-4-cores-16gb
    if: ${{ github.repository_owner == 'openvinotoolkit' }}
    container:
      image: openvinogithubactions.azurecr.io/dockerhub/ubuntu:20.04
      volumes:
        - /mount:/mount
    steps:
      - name: Pre-Collecting Cache Info
        run: |
          echo "Pytest cache info: "
          CACHE_DIR="/mount/caches/pytest"
          if [ -d "$CACHE_DIR" ]; then
            du -h -d2 "$CACHE_DIR"
          else
            echo "Pytest cache directory does not exist"
          fi
          
      - name: Cleanup pytest cache
        run: |
          echo "Delete pytest cache files if they have not been used in over 3 days"
          CACHE_DIR="/mount/caches/pytest"
          if [ -d "$CACHE_DIR" ]; then
            find "$CACHE_DIR" ! -type d -atime +3 -delete
            echo "Cleanup directories older than 7 days in pytest cache"
            find "$CACHE_DIR"/*/ov_models -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
          fi

      - name: Post-Collecting Cache Info
        run: |
          echo "Pytest cache info after cleanup: "
          CACHE_DIR="/mount/caches/pytest"
          if [ -d "$CACHE_DIR" ]; then
            du -h -d2 "$CACHE_DIR"
          else
            echo "Pytest cache directory does not exist"
          fi